name: Claude AI Auto Review & Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    name: Run Tests
    outputs:
      test-status: ${{ steps.test-result.outputs.status }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests with detailed output
        id: test-result
        run: |
          echo "Running comprehensive test suite..."
          if npm test; then
            echo "âœ… All tests passed successfully"
            echo "status=passed" >> $GITHUB_OUTPUT
          else
            echo "âŒ Tests failed - see output above"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

  claude-review-and-merge:
    runs-on: ubuntu-latest
    name: Claude AI Review & Auto Merge
    needs: test
    if: github.event_name == 'pull_request' && needs.test.outputs.test-status == 'passed'
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v40
        with:
          files: |
            **/*.ts
            **/*.js
            **/*.tsx
            **/*.jsx
            **/*.json
            **/*.md

      - name: Setup Node.js for review
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install review dependencies
        run: |
          npm init -y
          npm install @anthropic-ai/sdk

      - name: Run Claude 4 Sonnet Review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          node -e "
          const Anthropic = require('@anthropic-ai/sdk');
          const { execSync } = require('child_process');
          const https = require('https');

          function httpRequest(url, options = {}) {
            return new Promise((resolve, reject) => {
              const urlObj = new URL(url);
              const req = https.request({
                hostname: urlObj.hostname,
                port: 443,
                path: urlObj.pathname + urlObj.search,
                method: options.method || 'GET',
                headers: { 'User-Agent': 'claude-bot', ...options.headers },
                timeout: 30000
              }, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  try {
                    resolve(res.statusCode < 300 ? JSON.parse(data) : Promise.reject(new Error(data)));
                  } catch(e) { reject(e); }
                });
              });
              req.on('error', reject);
              if (options.body) req.write(options.body);
              req.end();
            });
          }

          async function review() {
            try {
              console.log('ğŸš€ Starting Claude 4 Sonnet review...');
              
              const anthropic = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY });
              const files = (process.env.CHANGED_FILES || '').split(' ').filter(Boolean);
              
              console.log('ğŸ“ Changed files: ' + files.length);
              
              if (files.length === 0) {
                await httpRequest('https://api.github.com/repos/' + process.env.REPO_OWNER + '/' + process.env.REPO_NAME + '/issues/' + process.env.PR_NUMBER + '/comments', {
                  method: 'POST',
                  headers: {
                    'Authorization': 'token ' + process.env.GITHUB_TOKEN,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ body: '## ğŸ¤– Claude 4 Sonnet AIãƒ¬ãƒ“ãƒ¥ãƒ¼\\n\\n**çµæœ**: å¤‰æ›´å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ãªã—\\n\\n**åˆ¤å®š**: APPROVE' })
                });
                return;
              }

              let diff;
              try {
                diff = execSync('git diff origin/main...HEAD', { encoding: 'utf8', maxBuffer: 1024*1024 });
              } catch(e) {
                diff = 'Git diff error: ' + e.message;
              }

              const maxSize = 6000;
              const truncatedDiff = diff.length > maxSize ? diff.substring(0, maxSize) + '\\n[...truncated...]' : diff;

              console.log('ğŸ“Š Diff size: ' + diff.length + ' chars (sending ' + truncatedDiff.length + ')');

              const prData = await httpRequest('https://api.github.com/repos/' + process.env.REPO_OWNER + '/' + process.env.REPO_NAME + '/pulls/' + process.env.PR_NUMBER, {
                headers: {
                  'Authorization': 'token ' + process.env.GITHUB_TOKEN,
                  'Accept': 'application/vnd.github.v3+json'
                }
              });

              console.log('âœ… PR data: \"' + (prData.title || 'No title') + '\"');

              const prompt = '# å¤§ç›¸æ’²ã‚¢ãƒ—ãƒª ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ (Claude 4 Sonnet)\\n\\nã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªã‚·ãƒ‹ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚Claude 4 Sonnetã®æœ€æ–°èƒ½åŠ›ã‚’æ´»ç”¨ã—ã¦ã€ä»¥ä¸‹ã®PRã‚’å¾¹åº•çš„ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚\\n\\n## PRæƒ…å ±\\n- ã‚¿ã‚¤ãƒˆãƒ«: ' + (prData.title || 'No title') + '\\n- èª¬æ˜: ' + (prData.body || 'èª¬æ˜ãªã—') + '\\n- å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ' + files.length + '\\n\\n## å¤‰æ›´å†…å®¹\\n```diff\\n' + truncatedDiff + '\\n```\\n\\n## ãƒ¬ãƒ“ãƒ¥ãƒ¼åŸºæº– (Claude 4 Sonnetå¼·åŒ–ç‰ˆ)\\n1. **ã‚³ãƒ¼ãƒ‰å“è³ª**: TypeScriptå‹å®‰å…¨æ€§ã€å¯èª­æ€§ã€ä¿å®ˆæ€§ã€è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³\\n2. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: å…¥åŠ›å€¤æ¤œè¨¼ã€XSS/CSRFå¯¾ç­–ã€èªè¨¼ãƒ»èªå¯ã€ãƒ‡ãƒ¼ã‚¿ä¿è­·\\n3. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: åŠ¹ç‡çš„ãªã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã€ãƒ¡ãƒ¢ãƒªç®¡ç†ã€ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æœ€é©åŒ–\\n4. **ãƒ†ã‚¹ãƒˆå“è³ª**: ã‚«ãƒãƒ¬ãƒƒã‚¸ã€ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã€çµ±åˆãƒ†ã‚¹ãƒˆã€E2Eãƒ†ã‚¹ãƒˆ\\n5. **å¤§ç›¸æ’²ã‚¢ãƒ—ãƒªå›ºæœ‰**: åŠ›å£«ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã€ç•ªä»˜è¡¨ç¤ºæ­£ç¢ºæ€§ã€ç›¸æ’²ç”¨èªé©åˆ‡æ€§ã€ãƒ«ãƒ¼ãƒ«æº–æ‹ \\n6. **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**: ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ã€æ‹¡å¼µæ€§ã€è²¬å‹™åˆ†é›¢ã€ä¾å­˜é–¢ä¿‚\\n7. **ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£**: UI/UXã€ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ã€ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ\\n8. **é‹ç”¨**: ãƒ­ã‚°è¨­è¨ˆã€ç›£è¦–å¯èƒ½æ€§ã€ãƒ‡ãƒãƒƒã‚°å®¹æ˜“æ€§\\n\\n## åˆ¤å®šåŸºæº– (å³æ ¼)\\n- **APPROVE**: å…¨ã¦ã®å“è³ªåŸºæº–ã‚’æº€ãŸã—ã€è»½å¾®ãªæ”¹å–„ææ¡ˆã®ã¿\\n- **REQUEST_CHANGES**: å“è³ªãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»æ©Ÿèƒ½ã«ä¿®æ­£å¿…é ˆã®å•é¡Œã‚ã‚Š\\n- **COMMENT**: è¨­è¨ˆã®æ ¹æœ¬çš„ãªè¦‹ç›´ã—ã‚„å¤§è¦æ¨¡ãªæ”¹å–„ææ¡ˆ\\n\\n## å‡ºåŠ›å½¢å¼\\næœ€åˆã®è¡Œã«å¿…ãš: **DECISION: [APPROVE/REQUEST_CHANGES/COMMENT]**\\n\\nãã®å¾Œã€ä»¥ä¸‹ã®æ§‹é€ ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼:\\n### ğŸ¯ ç·åˆåˆ¤å®šç†ç”±\\n### âœ… å„ªç§€ãªå®Ÿè£…ç‚¹\\n### âš ï¸ æ”¹å–„ãŒå¿…è¦ãªç‚¹ (å„ªå…ˆåº¦ä»˜ã)\\n### ğŸ”§ å…·ä½“çš„ãªä¿®æ­£ææ¡ˆ (ã‚³ãƒ¼ãƒ‰ä¾‹ä»˜ã)\\n### ğŸ“š è¿½åŠ æ¤œè¨äº‹é …\\n\\nClaude 4 Sonnetã®é«˜åº¦ãªåˆ†æèƒ½åŠ›ã‚’æ´»ç”¨ã—ã€å»ºè¨­çš„ã§å®Ÿç”¨çš„ãªãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚';

              console.log('ğŸ¤– Requesting Claude 4 Sonnet review...');

              const response = await anthropic.messages.create({
                model: 'claude-sonnet-4-20250514',
                max_tokens: 3000,
                messages: [{ role: 'user', content: prompt }]
              });

              const reviewText = response.content[0].text;
              const decisionLine = reviewText.split('\\n').find(line => line.includes('DECISION:')) || reviewText.split('\\n')[0];
              
              let decision = 'COMMENT';
              if (decisionLine.includes('APPROVE')) decision = 'APPROVE';
              else if (decisionLine.includes('REQUEST_CHANGES')) decision = 'REQUEST_CHANGES';

              console.log('ğŸ“‹ Decision: ' + decision);

              const comment = '## ğŸ¤– Claude 4 Sonnet AIãƒ¬ãƒ“ãƒ¥ãƒ¼\\n\\n' + reviewText + '\\n\\n---\\n### ğŸ“Š ãƒ¬ãƒ“ãƒ¥ãƒ¼æƒ…å ±\\n- **AI ãƒ¢ãƒ‡ãƒ«**: Claude 4 Sonnet (æœ€æ–°)\\n- **åˆ¤å®š**: ' + decision + '\\n- **å®Ÿè¡Œæ™‚åˆ»**: ' + new Date().toISOString() + '\\n- **å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: ' + files.length + '\\n- **å¼·åŒ–æ©Ÿèƒ½**: âœ… é«˜åº¦ãªã‚³ãƒ¼ãƒ‰è§£æã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è©•ä¾¡\\n\\n*Claude 4 Sonnetã«ã‚ˆã‚‹æœ€æ–°AIè‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼*';

              await httpRequest('https://api.github.com/repos/' + process.env.REPO_OWNER + '/' + process.env.REPO_NAME + '/issues/' + process.env.PR_NUMBER + '/comments', {
                method: 'POST',
                headers: {
                  'Authorization': 'token ' + process.env.GITHUB_TOKEN,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ body: comment })
              });

              console.log('âœ… Claude 4 Sonnet review posted successfully');
              
            } catch (error) {
              console.error('âŒ Error:', error.message);
              
              try {
                await httpRequest('https://api.github.com/repos/' + process.env.REPO_OWNER + '/' + process.env.REPO_NAME + '/issues/' + process.env.PR_NUMBER + '/comments', {
                  method: 'POST',
                  headers: {
                    'Authorization': 'token ' + process.env.GITHUB_TOKEN,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ 
                    body: '## ğŸ¤– Claude 4 Sonnet AIãƒ¬ãƒ“ãƒ¥ãƒ¼ - ã‚¨ãƒ©ãƒ¼\\n\\nãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: `' + error.message + '`\\n\\n**å¯¾å¿œ**: æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚' 
                  })
                });
              } catch (e) {
                console.error('Failed to post error comment:', e);
              }
              
              process.exit(1);
            }
          }

          review();
          "

  deploy:
    runs-on: ubuntu-latest
    name: Deploy
    needs: [test, claude-review-and-merge]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy
