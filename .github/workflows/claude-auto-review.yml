name: Claude AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

jobs:
  # æ—¢å­˜ã®ãƒ†ã‚¹ãƒˆã‚¸ãƒ§ãƒ–
  test:
    runs-on: ubuntu-latest
    name: Run Tests
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        run: npm test

  # Claude AIãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¸ãƒ§ãƒ–
  claude-review:
    runs-on: ubuntu-latest
    name: Claude AI Review
    needs: test  # ãƒ†ã‚¹ãƒˆæˆåŠŸå¾Œã«å®Ÿè¡Œ
    if: github.event_name == 'pull_request'
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ã—ã¦diffã‚’æ­£ç¢ºã«

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v40
        with:
          files: |
            **/*.ts
            **/*.js
            **/*.tsx
            **/*.jsx
            **/*.json
            **/*.md

      - name: Setup Node.js for review script
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install review dependencies
        run: |
          npm install @anthropic-ai/sdk node-fetch@3

      - name: Run Claude AI Review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          cat > claude-review.js << 'EOF'
          const Anthropic = require('@anthropic-ai/sdk');
          const { execSync } = require('child_process');
          const fetch = require('node-fetch');

          async function runClaudeReview() {
            const anthropic = new Anthropic({
              apiKey: process.env.ANTHROPIC_API_KEY,
            });

            // å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®å·®åˆ†ã‚’å–å¾—
            const changedFiles = process.env.CHANGED_FILES?.split(' ') || [];
            
            if (changedFiles.length === 0) {
              console.log('No relevant files changed');
              return;
            }

            // Git diffã‚’å–å¾—
            const gitDiff = execSync('git diff origin/main...HEAD', { encoding: 'utf8' });
            
            // PRã®æƒ…å ±ã‚’å–å¾—
            const prResponse = await fetch(
              `https://api.github.com/repos/${process.env.REPO_OWNER}/${process.env.REPO_NAME}/pulls/${process.env.PR_NUMBER}`,
              {
                headers: {
                  'Authorization': `token ${process.env.GITHUB_TOKEN}`,
                  'Accept': 'application/vnd.github.v3+json',
                },
              }
            );
            const prData = await prResponse.json();

            // Claude ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä¾é ¼
            const reviewPrompt = `
            # ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼

            ä»¥ä¸‹ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚

            ## PRæƒ…å ±
            - ã‚¿ã‚¤ãƒˆãƒ«: ${prData.title}
            - èª¬æ˜Ž: ${prData.body || 'èª¬æ˜Žãªã—'}

            ## å¤‰æ›´å†…å®¹ï¼ˆGit Diffï¼‰
            \`\`\`diff
            ${gitDiff}
            \`\`\`

            ## ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹
            ä»¥ä¸‹ã®è¦³ç‚¹ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ï¼š

            1. **ã‚³ãƒ¼ãƒ‰å“è³ª**
               - TypeScriptåž‹å®‰å…¨æ€§
               - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
               - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹
               - å¯èª­æ€§ãƒ»ä¿å®ˆæ€§

            2. **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**
               - è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã®é©ç”¨
               - è²¬å‹™åˆ†é›¢
               - æ‹¡å¼µæ€§

            3. **ãƒ†ã‚¹ãƒˆ**
               - ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸
               - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®å¦¥å½“æ€§
               - ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®è€ƒæ…®

            4. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**
               - è„†å¼±æ€§ã®æœ‰ç„¡
               - å…¥åŠ›å€¤æ¤œè¨¼
               - èªè¨¼ãƒ»èªå¯

            5. **å¤§ç›¸æ’²ã‚¢ãƒ—ãƒªå›ºæœ‰**
               - åŠ›å£«ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§
               - ç•ªä»˜è¡¨ç¤ºã®æ­£ç¢ºæ€§
               - ç›¸æ’²ç”¨èªžã®é©åˆ‡ãªä½¿ç”¨

            ## å‡ºåŠ›å½¢å¼
            ä»¥ä¸‹ã®å½¢å¼ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š

            ### ðŸŽ¯ ç·åˆè©•ä¾¡
            [APPROVE/REQUEST_CHANGES/COMMENT]

            ### âœ… è‰¯ã„ç‚¹
            - [è‰¯ã„å®Ÿè£…ã‚„æ”¹å–„ç‚¹ã‚’å…·ä½“çš„ã«]

            ### âš ï¸ æ”¹å–„ææ¡ˆ
            - [æ”¹å–„ã™ã¹ãç‚¹ã‚’å…·ä½“çš„ã«ã€ã‚³ãƒ¼ãƒ‰ä¾‹ä»˜ãã§]

            ### ðŸ› æ½œåœ¨çš„ãªå•é¡Œ
            - [ãƒã‚°ã‚„è„†å¼±æ€§ã®å¯èƒ½æ€§ãŒã‚ã‚Œã°]

            ### ðŸ“š å­¦ç¿’ãƒ»å‚è€ƒãƒªã‚½ãƒ¼ã‚¹
            - [é–¢é€£ã™ã‚‹ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚„å‚è€ƒè³‡æ–™ãŒã‚ã‚Œã°]

            ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯å»ºè¨­çš„ã§ã€å…·ä½“çš„ãªæ”¹å–„æ¡ˆã‚’å«ã‚ã¦ãã ã•ã„ã€‚
            `;

            try {
              const response = await anthropic.messages.create({
                model: 'claude-3-5-sonnet-20241022',
                max_tokens: 4000,
                messages: [
                  {
                    role: 'user',
                    content: reviewPrompt
                  }
                ]
              });

              const reviewComment = response.content[0].text;
              
              // GitHubã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
              await fetch(
                `https://api.github.com/repos/${process.env.REPO_OWNER}/${process.env.REPO_NAME}/issues/${process.env.PR_NUMBER}/comments`,
                {
                  method: 'POST',
                  headers: {
                    'Authorization': `token ${process.env.GITHUB_TOKEN}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                    body: `## ðŸ¤– Claude AIãƒ¬ãƒ“ãƒ¥ãƒ¼

            ${reviewComment}

            ---
            *ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯Claude AIï¼ˆMax Planï¼‰ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*`
                  })
                }
              );

              console.log('Claude review posted successfully');
              
            } catch (error) {
              console.error('Error in Claude review:', error);
              process.exit(1);
            }
          }

          runClaudeReview();
          EOF

          # ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨­å®š
          export CHANGED_FILES="${{ steps.changed-files.outputs.all_changed_files }}"
          node claude-review.js

  # æ—¢å­˜ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¸ãƒ§ãƒ–ï¼ˆmainãƒžãƒ¼ã‚¸å¾Œï¼‰
  deploy:
    runs-on: ubuntu-latest
    name: Deploy
    needs: [test, claude-review]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy
