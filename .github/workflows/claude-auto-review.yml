name: Claude AI Auto Review & Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

jobs:
  # æ—¢å­˜ã®ãƒ†ã‚¹ãƒˆã‚¸ãƒ§ãƒ–
  test:
    runs-on: ubuntu-latest
    name: Run Tests
    outputs:
      test-status: ${{ steps.test-result.outputs.status }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        id: test-result
        run: |
          if npm test; then
            echo "status=passed" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

  # Claude AIãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼†è‡ªå‹•ãƒãƒ¼ã‚¸ã‚¸ãƒ§ãƒ–
  claude-review-and-merge:
    runs-on: ubuntu-latest
    name: Claude AI Review & Auto Merge
    needs: test
    if: github.event_name == 'pull_request' && needs.test.outputs.test-status == 'passed'
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v40
        with:
          files: |
            **/*.ts
            **/*.js
            **/*.tsx
            **/*.jsx
            **/*.json
            **/*.md

      - name: Setup Node.js for review script
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run Claude AI Review with Auto Decision
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          # ã¾ãšå¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          npm init -y
          npm install @anthropic-ai/sdk
          
          cat > claude-auto-review.js << 'EOF'
          const Anthropic = require('@anthropic-ai/sdk');
          const { execSync } = require('child_process');

          async function runClaudeAutoReview() {
            const anthropic = new Anthropic({
              apiKey: process.env.ANTHROPIC_API_KEY,
            });

            // å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®å·®åˆ†ã‚’å–å¾—
            const changedFiles = process.env.CHANGED_FILES?.split(' ') || [];
            
            if (changedFiles.length === 0) {
              console.log('No relevant files changed - auto approving');
              await approveAndMerge('å¤‰æ›´å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ãªã—');
              return;
            }

            // Git diffã‚’å–å¾—
            const gitDiff = execSync('git diff origin/main...HEAD', { encoding: 'utf8' });
            
            // HTTPSãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ï¼ˆfetch ã®ä»£ã‚ã‚Šï¼‰
            const https = require('https');
            const httpRequest = (url, options) => {
              return new Promise((resolve, reject) => {
                const req = https.request(url, options, (res) => {
                  let data = '';
                  res.on('data', (chunk) => data += chunk);
                  res.on('end', () => {
                    try {
                      resolve(JSON.parse(data));
                    } catch (error) {
                      resolve({ body: data, statusCode: res.statusCode });
                    }
                  });
                });
                req.on('error', reject);
                if (options.body) {
                  req.write(options.body);
                }
                req.end();
              });
            };

            // PRã®æƒ…å ±ã‚’å–å¾—
            const prData = await httpRequest(`https://api.github.com/repos/${process.env.REPO_OWNER}/${process.env.REPO_NAME}/pulls/${process.env.PR_NUMBER}`, {
              method: 'GET',
              headers: {
                'Authorization': `token ${process.env.GITHUB_TOKEN}`,
                'Accept': 'application/vnd.github.v3+json',
                'User-Agent': 'claude-review-bot'
              }
            });

            // éå»ã®Claude ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç¢ºèª
            const comments = await httpRequest(`https://api.github.com/repos/${process.env.REPO_OWNER}/${process.env.REPO_NAME}/issues/${process.env.PR_NUMBER}/comments`, {
              method: 'GET',
              headers: {
                'Authorization': `token ${process.env.GITHUB_TOKEN}`,
                'Accept': 'application/vnd.github.v3+json',
                'User-Agent': 'claude-review-bot'
              }
            });

            const claudeComments = comments.filter(comment => 
              comment.body && comment.body.includes('ğŸ¤– Claude AIãƒ¬ãƒ“ãƒ¥ãƒ¼')
            );

            // Claude ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä¾é ¼ï¼ˆè‡ªå‹•åˆ¤å®šç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰
            const reviewPrompt = `
            # è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼†ãƒãƒ¼ã‚¸åˆ¤å®š

            ã‚ãªãŸã¯å¤§ç›¸æ’²ã‚¢ãƒ—ãƒªã®ã‚·ãƒ‹ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã—ã¦ã€ä»¥ä¸‹ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã€**ãƒãƒ¼ã‚¸å¯å¦ã‚’æ˜ç¢ºã«åˆ¤å®š**ã—ã¦ãã ã•ã„ã€‚

            ## PRæƒ…å ±
            - ã‚¿ã‚¤ãƒˆãƒ«: ${prData.title}
            - èª¬æ˜: ${prData.body || 'èª¬æ˜ãªã—'}
            - éå»ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼å›æ•°: ${claudeComments.length}

            ## å¤‰æ›´å†…å®¹ï¼ˆGit Diffï¼‰
            \`\`\`diff
            ${gitDiff}
            \`\`\`

            ## å¿…é ˆå‡ºåŠ›å½¢å¼

            æœ€åˆã®è¡Œã«å¿…ãšä»¥ä¸‹ã®ã„ãšã‚Œã‹ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

            **DECISION: APPROVE**ï¼ˆè‡ªå‹•ãƒãƒ¼ã‚¸å®Ÿè¡Œï¼‰
            **DECISION: REQUEST_CHANGES**ï¼ˆãƒãƒ¼ã‚¸æ‹’å¦ãƒ»ä¿®æ­£è¦æ±‚ï¼‰
            **DECISION: COMMENT**ï¼ˆäººé–“ã«ã‚ˆã‚‹ç¢ºèªè¦æ±‚ï¼‰

            ãã®å¾Œã€ä»¥ä¸‹ã®å½¢å¼ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹ã‚’ç¶šã‘ã¦ãã ã•ã„ï¼š

            ### ğŸ¯ åˆ¤å®šç†ç”±
            [ãªãœã“ã®åˆ¤å®šã«ãªã£ãŸã‹ã‚’å…·ä½“çš„ã«èª¬æ˜]

            ### âœ… è‰¯ã„ç‚¹
            - [è‰¯ã„å®Ÿè£…ã‚„æ”¹å–„ç‚¹ã‚’å…·ä½“çš„ã«]

            ### âš ï¸ æ”¹å–„ææ¡ˆãƒ»å•é¡Œç‚¹
            - [æ”¹å–„ã™ã¹ãç‚¹ã‚’å…·ä½“çš„ã«ã€ã‚³ãƒ¼ãƒ‰ä¾‹ä»˜ãã§]

            ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯å³æ ¼ã«è¡Œã„ã€å“è³ªã‚’å¦¥å”ã—ãªã„ã§ãã ã•ã„ã€‚
            `;

            try {
              const response = await anthropic.messages.create({
                model: 'claude-3-5-sonnet-20241022',
                max_tokens: 4000,
                messages: [
                  {
                    role: 'user',
                    content: reviewPrompt
                  }
                ]
              });

              const reviewComment = response.content[0].text;
              const lines = reviewComment.split('\n');
              const decisionLine = lines[0];
              
              // åˆ¤å®šã‚’è§£æ
              let decision = 'COMMENT'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
              if (decisionLine.includes('DECISION: APPROVE')) {
                decision = 'APPROVE';
              } else if (decisionLine.includes('DECISION: REQUEST_CHANGES')) {
                decision = 'REQUEST_CHANGES';
              }

              // ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
              const commentBody = `## ğŸ¤– Claude AIãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆè‡ªå‹•åˆ¤å®šï¼‰

${reviewComment}

---
### ğŸš€ è‡ªå‹•å‡¦ç†çµæœ
- **åˆ¤å®š**: ${decision}
- **å‡¦ç†æ™‚åˆ»**: ${new Date().toISOString()}
- **ãƒ¬ãƒ“ãƒ¥ãƒ¼å›æ•°**: ${claudeComments.length + 1}å›ç›®

*ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯Claude AIï¼ˆMax Planï¼‰ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆãƒ»åˆ¤å®šã•ã‚Œã¾ã—ãŸ*`;

              await httpRequest(`https://api.github.com/repos/${process.env.REPO_OWNER}/${process.env.REPO_NAME}/issues/${process.env.PR_NUMBER}/comments`, {
                method: 'POST',
                headers: {
                  'Authorization': `token ${process.env.GITHUB_TOKEN}`,
                  'Accept': 'application/vnd.github.v3+json',
                  'Content-Type': 'application/json',
                  'User-Agent': 'claude-review-bot'
                },
                body: JSON.stringify({ body: commentBody })
              });

              console.log(`Claude review completed with decision: ${decision}`);
              
            } catch (error) {
              console.error('Error in Claude review:', error);
              process.exit(1);
            }
          }

          runClaudeAutoReview();
          EOF

          # ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨­å®š
          export CHANGED_FILES="${{ steps.changed-files.outputs.all_changed_files }}"
          node claude-auto-review.js

  # ãƒãƒ¼ã‚¸æˆåŠŸå¾Œã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
  deploy:
    runs-on: ubuntu-latest
    name: Deploy
    needs: [test, claude-review-and-merge]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy
