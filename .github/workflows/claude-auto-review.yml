name: Claude AI Auto Review & Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    name: Run Tests
    outputs:
      test-status: ${{ steps.test-result.outputs.status }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests with detailed output
        id: test-result
        run: |
          echo "Running comprehensive test suite..."
          if npm test; then
            echo "âœ… All tests passed successfully"
            echo "status=passed" >> $GITHUB_OUTPUT
          else
            echo "âŒ Tests failed - see output above"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

  claude-review-and-merge:
    runs-on: ubuntu-latest
    name: Claude AI Review & Auto Merge
    needs: test
    if: github.event_name == 'pull_request' && needs.test.outputs.test-status == 'passed'
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get changed files with details
        id: changed-files
        uses: tj-actions/changed-files@v40
        with:
          files: |
            **/*.ts
            **/*.js
            **/*.tsx
            **/*.jsx
            **/*.json
            **/*.md

      - name: Setup Node.js for review
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies for review
        run: |
          echo "Setting up review environment..."
          npm init -y
          npm install @anthropic-ai/sdk

      - name: Create package.json for review script
        run: |
          echo '{
            "name": "claude-review",
            "version": "1.0.0",
            "type": "commonjs",
            "dependencies": {
              "@anthropic-ai/sdk": "latest"
            }
          }' > package.json

      - name: Create secure HTTP module
        run: |
          cat > http-utils.js << 'EOF'
          const https = require('https');
          
          async function secureRequest(url, options = {}) {
            return new Promise((resolve, reject) => {
              const urlObj = new URL(url);
              const requestOptions = {
                hostname: urlObj.hostname,
                port: urlObj.port || 443,
                path: urlObj.pathname + urlObj.search,
                method: options.method || 'GET',
                headers: {
                  'User-Agent': 'claude-review-bot/1.0',
                  ...options.headers
                },
                rejectUnauthorized: true,
                timeout: 30000
              };

              const req = https.request(requestOptions, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  try {
                    if (res.statusCode >= 200 && res.statusCode < 300) {
                      resolve(JSON.parse(data));
                    } else {
                      reject(new Error(`HTTP ${res.statusCode}: ${data}`));
                    }
                  } catch (error) {
                    reject(new Error(`Parse error: ${error.message}`));
                  }
                });
              });

              req.on('error', reject);
              req.on('timeout', () => {
                req.destroy();
                reject(new Error('Request timeout'));
              });

              if (options.body) {
                req.write(options.body);
              }
              req.end();
            });
          }

          module.exports = { secureRequest };
          EOF

      - name: Create main review script
        run: |
          cat > claude-review.js << 'EOF'
          const Anthropic = require('@anthropic-ai/sdk');
          const { execSync } = require('child_process');
          const { secureRequest } = require('./http-utils');

          async function runClaudeReview() {
            try {
              console.log('ğŸš€ Starting Claude AI review process...');
              
              // Validate environment
              const required = ['ANTHROPIC_API_KEY', 'GITHUB_TOKEN', 'PR_NUMBER', 'REPO_OWNER', 'REPO_NAME'];
              for (const env of required) {
                if (!process.env[env]) {
                  throw new Error(`Missing environment variable: ${env}`);
                }
              }

              const anthropic = new Anthropic({
                apiKey: process.env.ANTHROPIC_API_KEY,
              });

              console.log('âœ… Environment validated');

              const changedFiles = process.env.CHANGED_FILES?.split(' ') || [];
              console.log(`ğŸ“ Changed files: ${changedFiles.length}`);
              
              if (changedFiles.length === 0) {
                await postComment('## ğŸ¤– Claude AIãƒ¬ãƒ“ãƒ¥ãƒ¼\n\n**çµæœ**: å¤‰æ›´å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ãªã—\n\n**åˆ¤å®š**: APPROVE');
                return;
              }

              console.log('ğŸ“Š Analyzing code changes...');
              let gitDiff;
              try {
                gitDiff = execSync('git diff origin/main...HEAD', { encoding: 'utf8', maxBuffer: 1024 * 1024 });
              } catch (error) {
                gitDiff = 'Git diff error: ' + error.message;
              }

              const maxSize = 8000;
              const diff = gitDiff.length > maxSize 
                ? gitDiff.substring(0, maxSize) + '\n[... truncated ...]'
                : gitDiff;

              console.log(`ğŸ“ Diff size: ${gitDiff.length} chars (sending ${diff.length})`);

              console.log('ğŸ“‹ Fetching PR information...');
              const prData = await secureRequest(
                `https://api.github.com/repos/${process.env.REPO_OWNER}/${process.env.REPO_NAME}/pulls/${process.env.PR_NUMBER}`,
                {
                  headers: {
                    'Authorization': `token ${process.env.GITHUB_TOKEN}`,
                    'Accept': 'application/vnd.github.v3+json'
                  }
                }
              );

              console.log(`âœ… PR data fetched: "${prData.title}"`);

              const prompt = `# å¤§ç›¸æ’²ã‚¢ãƒ—ãƒª ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼

ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªã‚·ãƒ‹ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚ä»¥ä¸‹ã®PRã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚

## PRæƒ…å ±
- ã‚¿ã‚¤ãƒˆãƒ«: ${prData.title || 'No title'}
- ä½œæˆè€…: ${prData.user?.login || 'Unknown'}
- èª¬æ˜: ${prData.body || 'èª¬æ˜ãªã—'}
- å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${changedFiles.length}

## å¤‰æ›´å†…å®¹
\`\`\`diff
${diff}
\`\`\`

## ãƒ¬ãƒ“ãƒ¥ãƒ¼åŸºæº–
1. **ã‚³ãƒ¼ãƒ‰å“è³ª**: TypeScriptå‹å®‰å…¨æ€§ã€å¯èª­æ€§ã€ä¿å®ˆæ€§
2. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: å…¥åŠ›å€¤æ¤œè¨¼ã€XSS/CSRFå¯¾ç­–
3. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: åŠ¹ç‡çš„ãªå®Ÿè£…
4. **ãƒ†ã‚¹ãƒˆ**: é©åˆ‡ãªãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸
5. **å¤§ç›¸æ’²ã‚¢ãƒ—ãƒªå›ºæœ‰**: åŠ›å£«ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã€ç•ªä»˜è¡¨ç¤ºæ­£ç¢ºæ€§

## åˆ¤å®šåŸºæº–
- **APPROVE**: è»½å¾®ãªæ”¹å–„ææ¡ˆã®ã¿ã€å“è³ªãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œãªã—
- **REQUEST_CHANGES**: ä¿®æ­£å¿…é ˆã®å•é¡Œã‚ã‚Š
- **COMMENT**: è¨­è¨ˆç›¸è«‡ã‚„å¤§ããªæ”¹å–„ææ¡ˆ

## å‡ºåŠ›å½¢å¼
æœ€åˆã®è¡Œã«å¿…ãšä»¥ä¸‹ã‚’å‡ºåŠ›:
**DECISION: [APPROVE/REQUEST_CHANGES/COMMENT]**

ãã®å¾Œã€å…·ä½“çš„ãªãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚`;

              console.log('ğŸ¤– Requesting Claude AI review...');
              
              const response = await anthropic.messages.create({
                model: 'claude-3-5-sonnet-20241022',
                max_tokens: 3000,
                messages: [{ role: 'user', content: prompt }]
              });

              const reviewComment = response.content[0].text;
              console.log('âœ… Claude AI review completed');

              const decisionLine = reviewComment.split('\n').find(line => line.includes('DECISION:')) || reviewComment.split('\n')[0];
              
              let decision = 'COMMENT';
              if (decisionLine.includes('DECISION: APPROVE')) {
                decision = 'APPROVE';
              } else if (decisionLine.includes('DECISION: REQUEST_CHANGES')) {
                decision = 'REQUEST_CHANGES';
              }

              console.log(`ğŸ“‹ Review decision: ${decision}`);

              const commentBody = `## ğŸ¤– Claude AIãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆæ”¹å–„ç‰ˆï¼‰

${reviewComment}

---
### ğŸ“Š ãƒ¬ãƒ“ãƒ¥ãƒ¼æƒ…å ±
- **åˆ¤å®š**: ${decision}
- **å®Ÿè¡Œæ™‚åˆ»**: ${new Date().toISOString()}
- **å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: ${changedFiles.length}
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–**: âœ… TLS 1.2, ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: âœ… åŒ…æ‹¬çš„ãªä¾‹å¤–å‡¦ç†

*Claude AI Sonnet 3.5 æ”¹å–„ç‰ˆã«ã‚ˆã‚‹è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼*`;

              await postComment(commentBody);
              console.log('âœ… Review comment posted successfully');
              console.log(`ğŸ¯ Review completed: ${decision}`);
              
            } catch (error) {
              console.error('âŒ Review error:', error);
              
              try {
                await postComment(`## ğŸ¤– Claude AIãƒ¬ãƒ“ãƒ¥ãƒ¼ - ã‚¨ãƒ©ãƒ¼

ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:

\`${error.message}\`

**å¯¾å¿œ**: æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚

*ã‚¨ãƒ©ãƒ¼æ™‚åˆ»: ${new Date().toISOString()}*`);
              } catch (commentError) {
                console.error('Failed to post error comment:', commentError);
              }
              
              process.exit(1);
            }
          }

          async function postComment(body) {
            await secureRequest(
              `https://api.github.com/repos/${process.env.REPO_OWNER}/${process.env.REPO_NAME}/issues/${process.env.PR_NUMBER}/comments`,
              {
                method: 'POST',
                headers: {
                  'Authorization': `token ${process.env.GITHUB_TOKEN}`,
                  'Accept': 'application/vnd.github.v3+json',
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ body })
              }
            );
          }

          runClaudeReview();
          EOF

      - name: Execute Claude AI Review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          echo "ğŸš€ Starting Claude AI review execution..."
          node claude-review.js
          echo "âœ… Claude AI review execution completed"

  deploy:
    runs-on: ubuntu-latest
    name: Deploy
    needs: [test, claude-review-and-merge]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy
