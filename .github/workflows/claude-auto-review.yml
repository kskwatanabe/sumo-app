name: Claude AI Auto Review & Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    name: Run Tests
    outputs:
      test-status: ${{ steps.test-result.outputs.status }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests with detailed output
        id: test-result
        run: |
          echo "Running comprehensive test suite..."
          if npm test; then
            echo "âœ… All tests passed successfully"
            echo "status=passed" >> $GITHUB_OUTPUT
          else
            echo "âŒ Tests failed - see output above"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

  claude-review-and-merge:
    runs-on: ubuntu-latest
    name: Claude AI Review & Auto Merge
    needs: test
    if: github.event_name == 'pull_request' && needs.test.outputs.test-status == 'passed'
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get changed files with details
        id: changed-files
        uses: tj-actions/changed-files@v40
        with:
          files: |
            **/*.ts
            **/*.js
            **/*.tsx
            **/*.jsx
            **/*.json
            **/*.md

      - name: Setup Node.js for review
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies for review
        run: |
          echo "Setting up review environment..."
          npm init -y
          npm install @anthropic-ai/sdk

      - name: Create comprehensive review script
        run: |
          cat > claude-review.js << 'SCRIPT_EOF'
          /**
           * Claude AI Code Review Script
           * Performs automated code review using Claude AI API
           * Includes comprehensive error handling and security measures
           */
          const Anthropic = require('@anthropic-ai/sdk');
          const { execSync } = require('child_process');
          const https = require('https');

          /**
           * Secure HTTPS request function with proper error handling
           * @param {string} url - Target URL
           * @param {object} options - Request options
           * @returns {Promise} - Response data
           */
          async function secureHttpRequest(url, options = {}) {
            return new Promise((resolve, reject) => {
              try {
                const urlObj = new URL(url);
                const requestOptions = {
                  hostname: urlObj.hostname,
                  port: urlObj.port || 443,
                  path: urlObj.pathname + urlObj.search,
                  method: options.method || 'GET',
                  headers: {
                    'User-Agent': 'claude-review-bot/1.0',
                    ...options.headers
                  },
                  // Security settings
                  rejectUnauthorized: true,
                  secureProtocol: 'TLSv1_2_method'
                };

                const req = https.request(requestOptions, (res) => {
                  let data = '';
                  
                  res.on('data', (chunk) => {
                    data += chunk;
                  });
                  
                  res.on('end', () => {
                    try {
                      if (res.statusCode >= 200 && res.statusCode < 300) {
                        const parsed = JSON.parse(data);
                        resolve(parsed);
                      } else {
                        reject(new Error(`HTTP ${res.statusCode}: ${data}`));
                      }
                    } catch (parseError) {
                      reject(new Error(`JSON Parse Error: ${parseError.message}`));
                    }
                  });
                });

                req.on('error', (error) => {
                  reject(new Error(`Request Error: ${error.message}`));
                });

                req.on('timeout', () => {
                  req.destroy();
                  reject(new Error('Request timeout'));
                });

                // Set timeout to 30 seconds
                req.setTimeout(30000);
                
                if (options.body) {
                  req.write(options.body);
                }
                
                req.end();
              } catch (error) {
                reject(new Error(`Request Setup Error: ${error.message}`));
              }
            });
          }

          /**
           * Main Claude AI review function
           * Validates environment, fetches PR data, and performs review
           */
          async function runClaudeReview() {
            try {
              console.log('ğŸš€ Starting Claude AI review process...');
              
              // Validate required environment variables
              const requiredEnvVars = ['ANTHROPIC_API_KEY', 'GITHUB_TOKEN', 'PR_NUMBER', 'REPO_OWNER', 'REPO_NAME'];
              for (const envVar of requiredEnvVars) {
                if (!process.env[envVar]) {
                  throw new Error(`Missing required environment variable: ${envVar}`);
                }
              }

              // Initialize Anthropic client with error handling
              const anthropic = new Anthropic({
                apiKey: process.env.ANTHROPIC_API_KEY,
              });

              console.log('âœ… Environment validated');

              // Get changed files
              const changedFiles = process.env.CHANGED_FILES?.split(' ') || [];
              console.log(`ğŸ“ Changed files: ${changedFiles.length} files`);
              
              if (changedFiles.length === 0) {
                console.log('â„¹ï¸ No relevant files changed - posting informational comment');
                await postComment('## ğŸ¤– Claude AIãƒ¬ãƒ“ãƒ¥ãƒ¼\n\n**çµæœ**: å¤‰æ›´å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ãªã—\n\n**åˆ¤å®š**: APPROVE (è‡ªå‹•æ‰¿èª)');
                return;
              }

              // Get comprehensive git diff (limit to prevent token overflow)
              console.log('ğŸ“Š Analyzing code changes...');
              let gitDiff;
              try {
                gitDiff = execSync('git diff origin/main...HEAD', { 
                  encoding: 'utf8',
                  maxBuffer: 1024 * 1024 // 1MB limit
                });
              } catch (gitError) {
                console.error('Git diff error:', gitError.message);
                gitDiff = 'Error retrieving git diff: ' + gitError.message;
              }

              // Limit diff size for API
              const maxDiffSize = 8000; // Increased from 3000
              const truncatedDiff = gitDiff.length > maxDiffSize 
                ? gitDiff.substring(0, maxDiffSize) + '\n\n[... diff truncated for review ...]'
                : gitDiff;

              console.log(`ğŸ“ Diff size: ${gitDiff.length} chars (sending ${truncatedDiff.length} chars)`);

              // Fetch PR data with proper error handling
              console.log('ğŸ“‹ Fetching PR information...');
              const prData = await secureHttpRequest(
                `https://api.github.com/repos/${process.env.REPO_OWNER}/${process.env.REPO_NAME}/pulls/${process.env.PR_NUMBER}`,
                {
                  method: 'GET',
                  headers: {
                    'Authorization': `token ${process.env.GITHUB_TOKEN}`,
                    'Accept': 'application/vnd.github.v3+json'
                  }
                }
              );

              console.log(`âœ… PR data fetched: "${prData.title}"`);

              // Enhanced review prompt
              const reviewPrompt = `# å¤§ç›¸æ’²ã‚¢ãƒ—ãƒªè‡ªå‹•ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼

ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªã‚·ãƒ‹ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã—ã¦ã€ä»¥ä¸‹ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚

## PRæƒ…å ±
- **ã‚¿ã‚¤ãƒˆãƒ«**: ${prData.title || 'No title'}
- **ä½œæˆè€…**: ${prData.user?.login || 'Unknown'}
- **èª¬æ˜**: ${prData.body || 'èª¬æ˜ãªã—'}
- **å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: ${changedFiles.length}

## å¤‰æ›´å†…å®¹ï¼ˆGit Diffï¼‰
\`\`\`diff
${truncatedDiff}
\`\`\`

## ãƒ¬ãƒ“ãƒ¥ãƒ¼åŸºæº–
ä»¥ä¸‹ã®è¦³ç‚¹ã§å³æ ¼ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ï¼š

### 1. ã‚³ãƒ¼ãƒ‰å“è³ª (å¿…é ˆ)
- TypeScriptå‹å®‰å…¨æ€§
- ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ãƒ»ä¿å®ˆæ€§
- å‘½åè¦å‰‡ã®éµå®ˆ
- é©åˆ‡ãªã‚³ãƒ¡ãƒ³ãƒˆ

### 2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ (å¿…é ˆ)
- å…¥åŠ›å€¤æ¤œè¨¼
- XSS/CSRFå¯¾ç­–
- æ©Ÿå¯†æƒ…å ±ã®é©åˆ‡ãªå‡¦ç†
- ä¾å­˜é–¢ä¿‚ã®å®‰å…¨æ€§

### 3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- åŠ¹ç‡çš„ãªã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
- ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡
- ä¸è¦ãªå‡¦ç†ã®å›é¿

### 4. ãƒ†ã‚¹ãƒˆ
- ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸
- ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®è€ƒæ…®
- ãƒ†ã‚¹ãƒˆã®å“è³ª

### 5. å¤§ç›¸æ’²ã‚¢ãƒ—ãƒªå›ºæœ‰
- åŠ›å£«ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§
- ç•ªä»˜è¡¨ç¤ºã®æ­£ç¢ºæ€§
- ç›¸æ’²ç”¨èªã®é©åˆ‡ãªä½¿ç”¨

## åˆ¤å®šåŸºæº–
- **APPROVE**: è»½å¾®ãªæ”¹å–„ææ¡ˆã®ã¿ã§ã€å“è³ªãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«å•é¡Œãªã—
- **REQUEST_CHANGES**: ä¿®æ­£å¿…é ˆã®å•é¡Œã‚ã‚Šï¼ˆãƒã‚°ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã€é‡å¤§ãªå“è³ªå•é¡Œï¼‰
- **COMMENT**: è¨­è¨ˆã®ç›¸è«‡ã‚„å¤§ããªæ”¹å–„ææ¡ˆ

## å¿…é ˆå‡ºåŠ›å½¢å¼
æœ€åˆã®è¡Œã«å¿…ãšä»¥ä¸‹ã‚’å‡ºåŠ›ï¼š

**DECISION: [APPROVE/REQUEST_CHANGES/COMMENT]**

ãã®å¾Œã€ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚

ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯å»ºè¨­çš„ã§ã€å…·ä½“çš„ãªæ”¹å–„æ¡ˆã‚’å«ã‚ã¦ãã ã•ã„ã€‚`;

              console.log('ğŸ¤– Requesting Claude AI review...');
              
              // Request Claude AI review
              const response = await anthropic.messages.create({
                model: 'claude-3-5-sonnet-20241022',
                max_tokens: 3000,
                messages: [{ role: 'user', content: reviewPrompt }]
              });

              const reviewComment = response.content[0].text;
              console.log('âœ… Claude AI review completed');

              // Parse decision
              const lines = reviewComment.split('\n');
              const decisionLine = lines.find(line => line.includes('DECISION:')) || lines[0];
              
              let decision = 'COMMENT'; // Default safe fallback
              if (decisionLine.includes('DECISION: APPROVE')) {
                decision = 'APPROVE';
              } else if (decisionLine.includes('DECISION: REQUEST_CHANGES')) {
                decision = 'REQUEST_CHANGES';
              }

              console.log(`ğŸ“‹ Review decision: ${decision}`);

              // Post comprehensive comment
              const commentBody = `## ğŸ¤– Claude AIãƒ¬ãƒ“ãƒ¥ãƒ¼

${reviewComment}

---
### ğŸ“Š ãƒ¬ãƒ“ãƒ¥ãƒ¼æƒ…å ±
- **åˆ¤å®š**: ${decision}
- **å®Ÿè¡Œæ™‚åˆ»**: ${new Date().toISOString()}
- **å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: ${changedFiles.length}
- **ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡**: ${changedFiles.slice(0, 5).join(', ')}${changedFiles.length > 5 ? ` (+${changedFiles.length - 5} more)` : ''}

*ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯Claude AI (Sonnet 3.5) ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*`;

              await postComment(commentBody);
              console.log('âœ… Review comment posted successfully');

              // Log final status
              console.log(`ğŸ¯ Review process completed with decision: ${decision}`);
              
            } catch (error) {
              console.error('âŒ Critical error in Claude review:', error);
              
              // Post error comment for transparency
              try {
                await postComment(`## ğŸ¤– Claude AIãƒ¬ãƒ“ãƒ¥ãƒ¼ - ã‚¨ãƒ©ãƒ¼

ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š

\`\`\`
${error.message}
\`\`\`

**å¯¾å¿œ**: æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚

*ã‚¨ãƒ©ãƒ¼æ™‚åˆ»: ${new Date().toISOString()}*`);
              } catch (commentError) {
                console.error('Failed to post error comment:', commentError);
              }
              
              process.exit(1);
            }
          }

          /**
           * Posts a comment to the PR
           * @param {string} commentBody - Comment content
           */
          async function postComment(commentBody) {
            try {
              await secureHttpRequest(
                `https://api.github.com/repos/${process.env.REPO_OWNER}/${process.env.REPO_NAME}/issues/${process.env.PR_NUMBER}/comments`,
                {
                  method: 'POST',
                  headers: {
                    'Authorization': `token ${process.env.GITHUB_TOKEN}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({ body: commentBody })
                }
              );
            } catch (error) {
              throw new Error(`Failed to post comment: ${error.message}`);
            }
          }

          // Execute main function
          runClaudeReview();
          SCRIPT_EOF

      - name: Execute Claude AI Review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          echo "ğŸš€ Starting Claude AI review execution..."
          node claude-review.js
          echo "âœ… Claude AI review execution completed"

  deploy:
    runs-on: ubuntu-latest
    name: Deploy
    needs: [test, claude-review-and-merge]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Deploy to Cloudflare Workers
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy
